#Main: upload functions, leaves everything ready to conduct the classification of a data/MMap file
#						and to evaluate the performances
#Depending on the taxonomy desired, on alpha, on WSD

setwd('/home/igna/Desktop/Programs GBD/Classifier_Trial_GBD')
library(gdata)
library(e1071)

#Functions Upload: on upload que les fonctions non temporaires (fichiers finissant par un ~)
for(x in list.files("./Functions","[a-zA-Z]$")) source(paste("./Functions/",x,sep=""))

#MetaMap data
MMap <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/MMap_tot.txt")
##########################################################################################################
#Param choices: Condition Priority
#################################################################################
alpha <- (0.2)/100
wsd <- "Yes"
gamma <- c(0.05,0.1,0.2,0.5,1)
cost <- 10^(0:2)
#Text field: all fields equal, condition priority ou condition only
COND <- TRUE
COND_only <- FALSE
K <- 10

#Taxonomy choice
################
Tax <- "DL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")

#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
KV <- K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#            [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
# [1,] 0.00000000        NA        NA        NA 0.7571917 0.7695541 0.7300132
# [2,] 0.15364238 0.4101563 0.4448777 0.3836246 0.8209655 0.8286562 0.7942557
# [3,] 0.16826490 0.4106524 0.4598876 0.3679819 0.8280888 0.8325872 0.8043017
# [4,] 0.14099338 0.4314005 0.4534428 0.4115087 0.8101048 0.8198998 0.7827551
# [5,] 0.17423400 0.4474501 0.5004402 0.3872785 0.8227684 0.8258864 0.8029250
# [6,] 0.12169978 0.4651780 0.4860206 0.4391074 0.7980385 0.8088491 0.7712361
# [7,] 0.15627373 0.4832314 0.5376358 0.4127063 0.8088764 0.8132195 0.7894176
# [8,] 0.12238411 0.3931127 0.4250709 0.3685155 0.8077297 0.8164465 0.7810259## gamma = 0.1 cost = 1
# [9,] 0.13036203 0.3872281 0.4265734 0.3490828 0.8123648 0.8197154 0.7874095##
#[10,] 0.11970419 0.4389925 0.4607984 0.4197506 0.8001038 0.8104492 0.7725844
#[11,] 0.14099338 0.4555563 0.4912206 0.4133222 0.8066436 0.8141008 0.7825251
#[12,] 0.12766887 0.5240097 0.5378036 0.4962344 0.7916855 0.8033655 0.7652550
#[13,] 0.14962472 0.5276438 0.5571091 0.4773001 0.7977474 0.8066520 0.7746777
#[14,] 0.08979691 0.3765679 0.3933133 0.3598224 0.7942740 0.8059706 0.7664170## gamma = 0.2 cost = 1
#[15,] 0.09378808 0.3722330 0.3935239 0.3509421 0.7966336 0.8080291 0.7690114##
#[16,] 0.11039294 0.4400356 0.4565670 0.4253561 0.7963085 0.8077606 0.7680167
#[17,] 0.12436203 0.4622823 0.4975446 0.4212435 0.7993160 0.8083680 0.7741005
#[18,] 0.11901545 0.5368855 0.5535999 0.5222545 0.7867025 0.7982442 0.7581429
#[19,] 0.13298455 0.5457459 0.5800971 0.5062228 0.7895346 0.7986735 0.7640616
#[20,] 0.05853422 0.4393579 0.4474747 0.4312410 0.7774189 0.7898172 0.7493249
#[21,] 0.05986755 0.4391396 0.4535065 0.4247727 0.7781412 0.7902221 0.7503595
#[22,] 0.08910817 0.4794448 0.4862431 0.4726466 0.7844177 0.7971679 0.7553016
#[23,] 0.09510375 0.4838903 0.5018207 0.4659599 0.7862371 0.7979740 0.7580851
#[24,] 0.09572627 0.5822228 0.5881751 0.5762704 0.7758835 0.7886723 0.7465208
#[25,] 0.10172185 0.5777705 0.5962932 0.5592478 0.7776229 0.7893996 0.7492224
#[26,] 0.04390728 0.4604978 0.4604978 0.4604978 0.7709621 0.7838946 0.7425689
#[27,] 0.04457395 0.4604978 0.4676407 0.4533550 0.7711207 0.7837270 0.7430496
#[28,] 0.06915673 0.5559407 0.5590657 0.5528157 0.7716984 0.7845498 0.7428997
#[29,] 0.07248565 0.5551835 0.5736592 0.5367079 0.7726619 0.7845025 0.7448443
#[30,] 0.08312141 0.6268013 0.6297425 0.6238602 0.7699814 0.7830397 0.7408287
#[31,] 0.08844592 0.6317565 0.6470588 0.6164542 0.7704627 0.7825301 0.7422524
t1 <- proc.time()
(t1-t0)/60
#6.2min

#Taxonomy choice
#################
Tax <- "RL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")
#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
KV <- K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#            [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
# [1,] 0.00000000        NA        NA        NA 0.7617239 0.7638423 0.7027373
# [2,] 0.03856954 0.3065965 0.4067063 0.2086905 0.7821872 0.7799348 0.7254914## gamma = 0.05 cost = 1
# [3,] 0.07445475 0.3367573 0.4958826 0.1322919 0.7956836 0.7850748 0.7484446##
# [4,] 0.10439294 0.4308486 0.4669928 0.3864301 0.7997449 0.7978521 0.7394602## gamma = 0.05 cost = 10
# [5,] 0.16155408 0.4487067 0.5307889 0.3327371 0.8204893 0.8075512 0.7728344##
# [6,] 0.12833554 0.4862631 0.5000932 0.4326330 0.8005441 0.8014133 0.7408355
# [7,] 0.20146137 0.5102375 0.5724630 0.4134864 0.8232593 0.8105906 0.7739524
# [8,] 0.04055629 0.4562446 0.5707792 0.3850216 0.7746974 0.7728061 0.7163145
# [9,] 0.05916115 0.4447450 0.5880327 0.3114430 0.7813545 0.7757385 0.7271828
#[10,] 0.11969095 0.4735039 0.4990908 0.4257079 0.8006992 0.7992912 0.7400247
#[11,] 0.15426049 0.4862469 0.5335963 0.4031912 0.8112783 0.8049606 0.7565034
#[12,] 0.12369978 0.5025845 0.5250614 0.4732252 0.7960364 0.7951810 0.7329892
#[13,] 0.16691391 0.4957731 0.5446247 0.4322191 0.8122876 0.8049764 0.7538582
#[14,] 0.04388962 0.5593308 0.5728030 0.5286364 0.7718480 0.7730452 0.7119358
#[15,] 0.05186313 0.4996328 0.5757888 0.4264430 0.7760143 0.7743469 0.7179626
#[16,] 0.10041501 0.5395919 0.5462212 0.5071092 0.7865961 0.7880857 0.7244859
#[17,] 0.12302870 0.5249256 0.5520393 0.4639921 0.7946241 0.7926288 0.7357906
#[18,] 0.12436645 0.5882428 0.5932209 0.5682655 0.7869394 0.7879721 0.7223476
#[19,] 0.15562914 0.5699066 0.5947070 0.5238095 0.7979758 0.7944930 0.7360334
#[20,] 0.03924062 0.5806602 0.5785768 0.5514935 0.7705796 0.7726720 0.7105810
#[21,] 0.04256954 0.5364683 0.5904167 0.4623810 0.7720155 0.7726162 0.7130725
#[22,] 0.07249448 0.5990354 0.5906054 0.5726617 0.7752065 0.7779377 0.7137875
#[23,] 0.08380574 0.5744168 0.6083694 0.5319264 0.7804916 0.7796374 0.7198237
#[24,] 0.09110817 0.6114705 0.6034447 0.5879387 0.7766931 0.7793576 0.7139318
#[25,] 0.10308609 0.5916735 0.6101648 0.5572634 0.7820705 0.7816975 0.7199326
#[26,] 0.03391170 0.5357143 0.5452381 0.5309524 0.7696262 0.7712737 0.7087522
#[27,] 0.03524503 0.5357143 0.5623810 0.5138095 0.7699839 0.7709402 0.7097193
#[28,] 0.06318322 0.5913709 0.5836328 0.5667677 0.7740425 0.7762856 0.7125365
#[29,] 0.07116998 0.5767713 0.5886064 0.5458193 0.7778706 0.7786656 0.7165716
#[30,] 0.07979249 0.5764015 0.5734386 0.5580682 0.7771847 0.7794503 0.7145473
#[31,] 0.08911258 0.5797836 0.5867094 0.5496737 0.7801083 0.7813945 0.7183454
t1 <- proc.time()
(t1-t0)/60
#4.3 min

####################################################################################
#Param choices: All text fields
####################################################################################
alpha <- (0.2)/100
wsd <- "Yes"
gamma <- 0.1
cost <- 110
#Text field: all fields equal, condition priority ou condition only
COND <- FALSE
COND_only <- FALSE
K <- 10

#Taxonomy choice
################
Tax <- "DL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")
#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.0000000        NA        NA        NA 0.7503720 0.7708852 0.7167108
#[2,] 0.1250022 0.5005388 0.5259056 0.4688938 0.7860549 0.8053822 0.7529838
#[3,] 0.1575982 0.5050520 0.5689037 0.4316221 0.7960994 0.8084986 0.7697272
t1 <- proc.time()
(t1-t0)/60
#5.4min

#Taxonomy choice
Tax <- "RL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")
#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.0000000        NA        NA        NA 0.7526813 0.7654427 0.6867770
#[2,] 0.1143841 0.5113239 0.5422657 0.4724506 0.7823418 0.7925845 0.7132524
#[3,] 0.1815276 0.4902745 0.5775799 0.4079087 0.8084302 0.8047403 0.7461310
t1 <- proc.time()
(t1-t0)/60

##############################################################################
#Param choices: NO WSD (condition priority)
##############################################################################
alpha <- (0.2)/100
wsd <- "No"
gamma <- 0.1
cost <- 110
#Text field: all fields equal, condition priority ou condition only
COND <- TRUE
COND_only <- FALSE
K <- 10

#Taxonomy choice
################
Tax <- "DL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")

#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.0000000        NA        NA        NA 0.7553028 0.7688830 0.7266843
#[2,] 0.1436424 0.4809986 0.4931671 0.4705845 0.8011627 0.8149832 0.7697860
#[3,] 0.1649316 0.4966371 0.5264438 0.4599139 0.8059888 0.8163945 0.7788680
t1 <- proc.time()
(t1-t0)/60
#3.7min

#Taxonomy choice
#################
Tax <- "RL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")
#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#[1,] 0.0000000        NA        NA        NA 0.7625031 0.7650579 0.7040574
#[2,] 0.1137439 0.5043092 0.5276846 0.4725245 0.7954362 0.7950889 0.7337383
#[3,] 0.1642517 0.5184793 0.5624669 0.4425480 0.8103660 0.8042541 0.7545362
t1 <- proc.time()
(t1-t0)/60

#################################################################################



labs <- 0:nrow(Mgbd)

x <- sample(1:nrow(data))
L <- split(x,ceiling(seq_along(x)/(length(x)/K)))

Ptot <- c()
t0 <- proc.time()
for(i in 1:K){
#i <- sample(1:10,1)

trdt <- data[unlist(L[-i]),]
NCTstr <- tolower(as.character(trdt$PMID))
Mtr <- droplevels(MMap[MMap$NCT%in%paste("pbky",NCTstr,sep=""),])

tsdt <- data[unlist(L[i]),]
NCTsts <- tolower(as.character(tsdt$PMID))
Mts <- droplevels(MMap[MMap$NCT%in%paste("pbky",NCTsts,sep=""),])

TR <- training(trdt,Mgbd,Egbd,Mtr,MT,MTEB,alpha,wsd,gamma,cost,COND,COND_only)

MTc <- TR[[1]]
svm_mod_wrong <- TR[[2]]
remove(TR)

CL <- classifier(tsdt,Mts,MTc,wsd,svm_mod_wrong,COND,COND_only)

PERF <- Eval_CL(tsdt, CL)

Ptot <- c(Ptot,list(PERF))
}
#5.4min pour une valeur de chaque param.
t1 <- proc.time()
(t1-t0)/60

apply(simplify2array(Ptot), c(1,2), mean)
#          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.0000000        NA        NA        NA 0.7503720 0.7708852 0.7167108
#[2,] 0.1289978 0.5016443 0.5372731 0.4592461 0.7873782 0.8053079 0.7556851
#[3,] 0.1509536 0.5140155 0.5561863 0.4546052 0.7922428 0.8086489 0.7632310

#############################################################################
#GAMMA AND COST
############################################################################
alpha <- (0.2)/100
wsd <- "Yes"
gamma <- 1
cost <- 110
#Text field: all fields equal, condition priority ou condition only
COND <- TRUE
COND_only <- FALSE
K <- 10

#Taxonomy choice
################
Tax <- "DL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")

#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
KV <- K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
#           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.00000000        NA        NA        NA 0.7571917 0.7695541 0.7300132
#[2,] 0.08312141 0.6268013 0.6297425 0.6238602 0.7699814 0.7830397 0.7408287
#[3,] 0.08844592 0.6317565 0.6470588 0.6164542 0.7704627 0.7825301 0.7422524
t1 <- proc.time()
(t1-t0)/60
#4min

#Taxonomy choice
#################
Tax <- "RL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")
#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
KV <- K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
KV[1]
#           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.00000000        NA        NA        NA 0.7617239 0.7638423 0.7027373
#[2,] 0.08111700 0.5716396 0.5686766 0.5533063 0.7776451 0.7799271 0.7149306
#[3,] 0.09177042 0.5826921 0.5901924 0.5539648 0.7802696 0.7815810 0.7183531
t1 <- proc.time()
(t1-t0)/60
#4.2 min

##########################################################################################
alpha <- (0.2)/100
wsd <- "Yes"
gamma <- 0.1
cost <- 1
#Text field: all fields equal, condition priority ou condition only
COND <- TRUE
COND_only <- FALSE
K <- 10

#Taxonomy choice
################
Tax <- "DL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")

#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
KV <- K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
KV[1]
#          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.0000000        NA        NA        NA 0.7571917 0.7695541 0.7300132
#[2,] 0.1223841 0.3931127 0.4250709 0.3685155 0.8077297 0.8164465 0.7810259
#[3,] 0.1303620 0.3872281 0.4265734 0.3490828 0.8123648 0.8197154 0.7874095
t1 <- proc.time()
(t1-t0)/60
#4min

#Taxonomy choice
#################
Tax <- "RL"
if(Tax=="RL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot.txt")
if(Tax=="DL") data <- read.table("/media/igna/Elements/HotelDieu/Cochrane/MetaMapBurden/Trial_Burden_Param/NCT_data_tot_disag.txt")
#Data upload
L <- Data_upl(Tax)
Mgbd <- L[[1]]
Egbd <- L[[2]]
MT <- L[[3]]
MTEB <- L[[4]]
remove(L)

t0 <- proc.time()
set.seed(7212)
KV <- K_cross_valid(data,MMap,Mgbd,Egbd,MT,MTEB,K,alpha,wsd,gamma,cost,COND,COND_only)
KV[1]
#           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]      [,7]
#[1,] 0.00000000        NA        NA        NA 0.7617239 0.7638423 0.7027373
#[2,] 0.04055629 0.4562446 0.5707792 0.3850216 0.7746974 0.7728061 0.7163145
#[3,] 0.05916115 0.4447450 0.5880327 0.3114430 0.7813545 0.7757385 0.7271828
t1 <- proc.time()
(t1-t0)/60
#4.2 min













#####################################################################

table(unlist(lapply(strsplit(as.character(data$GBDnp),"&&"),length)))

table(as.numeric(unlist(strsplit(as.character(data$GBDnp),"&&"))))
Mgbd$cause_name[!1:nrow(Mgbd)%in%unique(as.numeric(unlist(strsplit(as.character(data$GBDnp),"&&"))))]
#GBDs non atteints par Emdin+JDZ

